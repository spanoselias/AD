/* Parser skeleton for processing item-???.xml files. Must be compiled in * JDK 1.5 or above. * * Instructions: * * This program processes all files passed on the command line (to parse * an entire diectory, type "java MyParser myFiles/*.xml" at the shell). * */import java.io.*;import java.text.*;import java.util.*;import org.xml.sax.XMLReader;import org.xml.sax.Attributes;import org.xml.sax.InputSource;import org.xml.sax.helpers.XMLReaderFactory;import org.xml.sax.helpers.DefaultHandler;public class MySAX_Mod extends DefaultHandler{	private String value="";	//	private int itemID=-1;	private double selRating=-1.0;	private String sellerID = "";	private double latitude = -1.0;	private double longitude=-1.0;	private boolean isCoord = false;	private String bidRating = "-1.0";	private String bidID = "";	private  static final String DEL="Â¬";	private String itemName="";	private String firstBid="-1.0";	private String currently= "";	private String started ="";	private String ends="";	private String descr ="";	private String noOfBids="";	private boolean isOpen=false;	private int countrID=-1;	private int categoryID=0;	private int categoryCounter=0;	private String categoryName="";	private String countryName="";	private String locationName=""; //location of table Location	private int locIDCounter = 0; //For the locID	private String time="";	private String amount="";	private String buyPrice = "-1.0";	private boolean isBidder = false;	private String bidderLoc = "";	private String bidderCountry="";	private int locID=-1;	//Hashmaps for deduplication	private HashSet <String> sellers = new HashSet <String>();	private HashSet<String> mapCoor = new HashSet<String>();	private HashMap<String, Integer> mapCountry = new HashMap<String,Integer>();	private HashMap<String,Integer>  mapLocation = new HashMap<String,Integer>();	private HashSet <String> bidders = new HashSet <String>();	private HashMap<String, Integer> categories = new HashMap<String, Integer>();	private static HashMap<String, String> dateTransfor = new HashMap<String,String>();	private HashSet <String> bid_Country = new HashSet <String>();	private HashSet <String> bid_Loc = new HashSet <String>();    public static void main (String args[])	throws Exception    {		dateTransfor.put("Jan" , "01");		dateTransfor.put("Feb" , "02");		dateTransfor.put("Mar" , "03");		dateTransfor.put("Apr" , "04");		dateTransfor.put("May" , "05");		dateTransfor.put("Jun" , "06");		dateTransfor.put("Jul" , "07");		dateTransfor.put("Aug" , "08");		dateTransfor.put("Sep" , "09");		dateTransfor.put("Oct" , "10");		dateTransfor.put("Nov" , "11");		dateTransfor.put("Dec" , "12");			String cur_dir = System.getProperty("user.dir");			File folder = new File(cur_dir);			File[] listOfFiles = folder.listFiles();			for (int i = 0; i < listOfFiles.length; i++) {				if (listOfFiles[i].isFile()) {					//System.out.println("File " + listOfFiles[i].getName());					String tempFile = listOfFiles[i].getName();					File fileTemp = new File(tempFile);					String ext = tempFile.substring(tempFile.lastIndexOf(".") + 1);					if (ext.equals("csv")){						fileTemp.delete();					}				}			}		XMLReader xr = XMLReaderFactory.createXMLReader();		MySAX_Mod handler = new MySAX_Mod();		xr.setContentHandler(handler);		xr.setErrorHandler(handler);					// Parse each file provided on the					// command line.		for (int i = 0; i < args.length; i++)		{			FileReader r = new FileReader(args[i]);			xr.parse(new InputSource(r));		}    }    public MySAX_Mod()    {		super();    }    /* Returns the amount (in XXXXX.xx format) denoted by a money-string     * like $3,453.23. Returns the input if the input is an empty string.     */    static String strip(String money) {        if (money.equals(""))            return money;        else {            double am = 0.0;            NumberFormat nf = NumberFormat.getCurrencyInstance(Locale.US);            try { am = nf.parse(money).doubleValue(); }            catch (ParseException e) {                System.out.println("This method should work for all " +                                   "money values you find in our data.");                System.exit(20);            }            nf.setGroupingUsed(false);            return nf.format(am).substring(1);        }    }    ////////////////////////////////////////////////////////////////////    // Event handlers.    ////////////////////////////////////////////////////////////////////    public void startDocument ()    {	System.out.println("Start document");    }    public void endDocument ()    {	System.out.println("End document");    }    public void startElement (String uri, String name,			      String qName, Attributes atts)    {	/*	if ("".equals (uri))	    System.out.println("Start element: " + qName);	else	    System.out.println("Start element: {" + uri + "}" + name);	for (int i = 0; i < atts.getLength(); i++) {	    System.out.println("Attribute: " + atts.getLocalName(i) + "=" + atts.getValue(i));	}*/		switch(name)		{			case "Item":				this.itemID = Integer.parseInt(atts.getValue(0));			break;			case "Location":				//We do not know for sure if there are both fields or				//non of them. So, we should check this case.				if (atts.getLength() == 2)				{					this.latitude = Double.parseDouble(atts.getValue(0));					this.longitude = Double.parseDouble(atts.getValue(1));					isCoord  =true;				}			break;			case "Bidder":				this.bidRating = atts.getValue(0);				this.bidID = atts.getValue(1);				this.isBidder  =true;				if ( !this.bidders.contains(this.bidID) )				{					this.bidders.add(this.bidID);					createCsvs("Bidder.csv");				}			break;			case "Seller":				this.selRating = Double.parseDouble(atts.getValue(0));				this.sellerID = atts.getValue(1);				if ( !this.sellers.contains(this.sellerID) )				{					this.sellers.add(this.sellerID);					createCsvs("Seller.csv");				}			break;		}//Switch    }    public void endElement (String uri, String name, String qName)    {		this.value = this.value.trim();		switch (name)		{			case "Location":				if(isBidder)				{					this.bidderLoc = this.value;					if(mapLocation.containsKey(bidderLoc) ==false)					{						this.locIDCounter +=1;						int locID = this.locIDCounter;						mapLocation.put(this.bidderLoc, locID);						//write to csv location						createCsvs("location.csv");					}					String tmpBidderLoc = this.bidID + "_" + this.bidderLoc;					if(!bid_Loc.contains(tmpBidderLoc))					{						bid_Loc.add(tmpBidderLoc);						//write to csv bidder_location (retrieve locid from hashmap)						createCsvs("Bidder_Location.csv");					}				}				else				{					this.locationName = this.value;					if(!mapLocation.containsKey(this.locationName))					{						this.locIDCounter +=1;						int locCounter = this.locIDCounter;						mapLocation.put(this.locationName, locCounter);						//It is increased the counter each time when new location						//is found						createCsvs("location.csv");					}				}				//It is check if there are coordinates, otherwise we do not				//want to create a table with null values				if(isCoord)				{					/*if(this.value.equals("New York"))					{						System.out.println(this.latitude);						System.out.println(this.longitude);						System.out.println(this.mapLocation.get(this.value));						System.out.println("Coord: " + isCoord);					}*/					String coorTemp = this.mapLocation.get(this.value) +  this.latitude + "_" + this.longitude;					if(!this.mapCoor.contains(coorTemp))					{						this.mapCoor.add(coorTemp);						createCsvs("Location_Det.csv");					}					isCoord=false;				}			break;			case "Country":				if(isBidder)				{					this.bidderCountry = this.value;					if(!mapCountry.containsKey(bidderCountry))					{						//System.out.println(this.bidderCountry);						this.countrID +=1;						int countryID = this.countrID;						mapCountry.put(this.bidderCountry, countryID);						//write to csv location						createCsvs("Country.csv");					}					String tmpBidderCountry = this.bidID + "_" + this.bidderCountry;					if(!bid_Country.contains(tmpBidderCountry))					{						bid_Country.add(tmpBidderCountry);						//write to csv bidder_location (retrieve locid from hashmap)						createCsvs("Bidder_Country.csv");					}				}				else				{					this.countryName = this.value;					if(!mapCountry.containsKey(this.countryName))					{						System.out.println(this.countryName);						this.countrID +=1;						int countryID = this.countrID;						mapCountry.put(this.countryName, countryID);						//It is increased the counter each time when new location						//is found						createCsvs("Country.csv");					}				}			break;			case "Category":				this.categoryName = this.value;				this.categoryName = this.value;				//It is increased the counter each time when a new category				//is found				if ( !this.categories.containsKey(this.categoryName)){					this.categoryCounter +=1;					this.categoryID =this.categoryCounter;					this.categories.put(this.categoryName, this.categoryID);					createCsvs("Category.csv");					createCsvs("Item_Category.csv");				}else{					this.categoryID = this.categories.get(this.categoryName);					createCsvs("Item_Category.csv");				}			break;			case "Currently":				this.currently = this.value.substring(1);			break;			case "Buy_Price":				this.buyPrice = this.value.substring(1);			break;			case "First_Bid":				this.firstBid = this.value.substring(1);			break;			case "Number_of_Bids":				this.noOfBids  = this.value;			break;			case "Item":				createCsvs("Item.csv");				if(!buyPrice.equals("-1.0"))				{					createCsvs("Init_Price.csv");					buyPrice = "-1.0";				}			break;			case "Description":				this.descr = this.value;			break;			case "Ends":				String tokensE[] = this.value.split(" ");				String dateE[] = tokensE[0].split("-");				this.ends  = "20" + dateE[2] + "-" + dateTransfor.get(dateE[0]) + "-" + dateE[1] + " " + tokensE[1];			break;			case "Started":				String tokensS[] = this.value.split(" ");				String dateS[] = tokensS[0].split("-");				this.started = "20" + dateS[2] + "-" + dateTransfor.get(dateS[0]) + "-" + dateS[1] + " " + tokensS[1];			break;			case "Amount":				this.amount = this.value.substring(1);			break;			case "Time":				String tokens[] = this.value.split(" ");				String date[] = tokens[0].split("-");				this.time = "20" + date[2] + "-" + dateTransfor.get(date[0]) + "-" + date[1] + " " + tokens[1];			break;			case "Bid":				createCsvs("Bid_Act.csv");			break;			case "Name":				this.itemName = this.value;			break;			case "Bidder":				/*if(isBidder)				{					if(bidderCountry != null)					{						System.out.println(this.bidderCountry);						bidderCountry =null;					}					if(bidderLoc != null)					{						System.out.println(this.bidderLoc);						bidderLoc=null;					}				}*/				isBidder = false;			break;		}		/*if ("".equals (uri))			System.out.println("End element: " + qName);		else			System.out.println("End element:   {" + uri + "}" + name);*/		this.value = "";	}    public void characters (char ch[], int start, int length)    {		 //new String(ch,start, length);	for (int i = start; i < start + length; i++) {	    switch (ch[i]) {	    case '\\':		//System.out.print("\\\\");		break;	    case '"':		//System.out.print("\\\"");		break;	    case '\n':		//System.out.print("\\n");		break;	    case '\r':		//System.out.print("\\r");		break;	    case '\t':	//	System.out.print("\\t");		break;	    default:			this.value += ch[i];		break;	    }	}	//System.out.println(ch.toString());    }	public  void createCsvs(String nameCsv)	{		BufferedWriter bw = null;		FileWriter fw = null;		PrintWriter out;		String content = "";		try		{			switch (nameCsv)			{				case "Seller.csv":					content = this.sellerID + DEL + this.selRating + "\n";					fw = new FileWriter("Seller.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					File newfile = new File("Seller.csv");					if( newfile.length() == 0)					{						String header = "SellerID" + DEL + "rating" + "\n";						out.print(header);					}					out.print(content);				break;				case "location.csv":					content = this.mapLocation.get(this.value) + DEL + this.value + "\n";					fw = new FileWriter("location.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("location.csv");					if( newfile.length() == 0)					{						String header = "locID" + DEL + "location" + "\n";						out.print(header);					}					out.print(content);				break;				case "Location_Det.csv":					content = this.mapLocation.get(this.value) + DEL + this.longitude  + DEL + this.latitude + "\n";					fw = new FileWriter("Location_Det.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Location_Det.csv");					if( newfile.length() == 0)					{						String header = "locID" + DEL + "Longitude" + DEL + "Latitude"  + "\n";						out.print(header);					}					out.print(content);				break;				case "Country.csv":					content = this.mapCountry.get(this.value) + DEL + this.value + "\n";					fw = new FileWriter("Country.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Country.csv");					if( newfile.length() == 0)					{						String header = "countryID" + DEL + "name" + "\n";						out.print(header);					}					out.print(content);				break;				case "Category.csv":					content = this.categoryID + DEL + this.categoryName + "\n";					fw = new FileWriter("Category.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Category.csv");					if( newfile.length() == 0)					{						String header = "categoryID" + DEL + "name" + "\n";						out.print(header);					}					out.print(content);					break;				case "Init_Price.csv":					content = this.itemID + DEL + this.buyPrice + "\n";					fw = new FileWriter("Init_Price.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Init_Price.csv");					if( newfile.length() == 0)					{						String header = "itemID" + DEL + "buyPrice" + "\n";						out.print(header);					}					out.print(content);				break;				case "Item_Category.csv":					content = this.itemID + DEL + this.categoryID + "\n";					fw = new FileWriter("Item_Category.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Item_Category.csv");					if( newfile.length() == 0)					{						String header = "itemID" + DEL + "categoryID" + "\n";						out.print(header);					}					out.print(content);				break;				case "Bidder.csv":					content = this.bidID + DEL + this.bidRating + "\n";					fw = new FileWriter("Bidder.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Bidder.csv");					if( newfile.length() == 0)					{						String header = "bidderID" + DEL + "rating" + "\n";						out.print(header);					}					out.print(content);				break;				case "Bid_Act.csv":					content = this.itemID + DEL + this.bidID+ DEL+ this.time + DEL +this.amount + "\n";					fw = new FileWriter("Bid_Act.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Bid_Act.csv");					if( newfile.length() == 0)					{						String header = "itemID" + DEL + "bidderID" + DEL + "time" + DEL + amount + "\n";						out.print(header);					}					out.print(content);				break;				case "Bidder_Location.csv":					content = this.bidID + DEL + mapLocation.get(this.bidderLoc) + "\n";					fw = new FileWriter("Bidder_Location.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Bidder_Location.csv");					if( newfile.length() == 0)					{						String header = "bidderID" + DEL + "locID" + "\n";						out.print(header);					}					out.print(content);				break;				case "Bidder_Country.csv":					content = this.bidID + DEL + this.mapCountry.get(this.bidderCountry) + "\n";					fw = new FileWriter("Bidder_Country.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Bidder_Country.csv");					if( newfile.length() == 0)					{						String header = "bidderID" + DEL + "countryID" + "\n";						out.print(header);					}					out.print(content);				break;				case "Item.csv":					String descTmp = "";					if( this.descr.length() < 4000)					{						 descTmp = this.descr;					}					else					{						descTmp = this.descr.substring(0,4000);					}					content = this.itemID + DEL + this.itemName + DEL + this.firstBid + DEL + this.currently +DEL + this.started + DEL + this.ends + DEL + descTmp + DEL+ this.noOfBids + DEL + this.isOpen +DEL + this.sellerID + DEL + this.countrID + DEL  + this.locIDCounter +  "\n";					fw = new FileWriter("Item.csv", true);					bw = new BufferedWriter(fw);					out = new PrintWriter(bw);					newfile = new File("Item.csv");					if( newfile.length() == 0)					{						String header = "itemID" + DEL + "itemName" + DEL + "firstBid" + DEL + "currently" + DEL + "started" + DEL + "ends" + DEL + "descr" + DEL + "noOfBids" + DEL + "isOpen" + DEL + "selID" + DEL + "countryID"  +DEL +"locID" + "\n";						out.print(header);					}					out.print(content);				break;			}		} catch (IOException e)		{			e.printStackTrace();		} finally		 {			try			{				if (bw != null)					bw.close();				if (fw != null)					fw.close();			} catch (IOException ex)			{				ex.printStackTrace();			}		}	}}